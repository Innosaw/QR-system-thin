<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innosaw Thin Scanner - Raw Scans</title>
    <link rel="stylesheet" href="/static/common.css?v=20251222">
    <style>
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
        .small { font-size:12px; color:#666; }
        .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#1f2937; font-size:12px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“„ Raw Scans (Thin)</h1>
        <div class="subtitle">Local view of scan history (no cloud required).</div>
        <div class="nav">
            <a href="/">Dashboard</a>
            <a href="/admin">Admin Mapping</a>
            <a class="active" href="/raw_scans">Raw Scans</a>
            <a href="/help">Help</a>
            <a href="{{ cloud_url }}" target="_blank" rel="noopener">Cloud Dashboard</a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="row">
                <div class="small">Source: <span class="pill" id="src">â€¦</span></div>
                <div class="small">Showing last</div>
                <input id="limit" type="number" min="1" max="1000" value="250" style="width:110px;">
                <button class="btn btn-secondary" onclick="refresh()">Refresh</button>
                <a class="btn btn-primary" href="/api/thin/raw_scans/download">Download Raw JSONL</a>
            </div>
            <div class="row" style="margin-top:10px;">
                <input id="filter" placeholder="Filter (station or text)" style="min-width:280px;">
                <span class="small" id="count">0</span>
            </div>
        </div>

        <div class="card">
            <div id="list" style="border:1px solid #eee; border-radius:6px; padding:10px; max-height:520px; overflow:auto;">
                <em>Loadingâ€¦</em>
            </div>
        </div>
    </div>

    <script>
        let items = [];
        function esc(v) {
            return String(v ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        function render() {
            const box = document.getElementById('list');
            const q = (document.getElementById('filter').value || '').trim().toLowerCase();
            const filtered = !q ? items : items.filter(it => {
                const station = String(it.station_code || it.station || it.station_name || '').toLowerCase();
                const raw = String(it.raw_data || it.data || it.payload || it.qr_data || it.code || '').toLowerCase();
                return station.includes(q) || raw.includes(q);
            });
            document.getElementById('count').textContent = `${filtered.length} scans`;
            if (!filtered.length) {
                box.innerHTML = '<em>No scans found.</em>';
                return;
            }
            box.innerHTML = filtered.map(it => {
                const ts = esc(it.timestamp || it.local_timestamp || '');
                const st = esc(it.station_code || it.station || it.station_name || 'Unknown');
                const raw = esc(it.raw_data || it.data || it.payload || it.qr_data || it.code || '');
                return `
                    <div style="padding:8px; border-bottom:1px solid #eee;">
                        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:baseline;">
                            <strong>${st}</strong>
                            <span class="small">${ts}</span>
                        </div>
                        <div class="mono" style="font-size:12px; margin-top:4px;">${raw}</div>
                    </div>
                `;
            }).join('');
        }

        async function refresh() {
            const srcEl = document.getElementById('src');
            srcEl.textContent = 'â€¦';
            const n = Math.max(1, Math.min(1000, parseInt(document.getElementById('limit').value || '250', 10) || 250));
            try {
                const res = await fetch(`/api/thin/recent_scans?limit=${n}`, { headers: { 'Accept': 'application/json' } });
                const data = await res.json();
                items = data.items || [];
                srcEl.textContent = (data.source || 'unknown');
                render();
            } catch (e) {
                items = [];
                srcEl.textContent = 'error';
                document.getElementById('list').innerHTML = '<em>Failed to load.</em>';
            }
        }

        document.getElementById('filter').addEventListener('input', render);
        refresh();
    </script>
</body>
</html>


